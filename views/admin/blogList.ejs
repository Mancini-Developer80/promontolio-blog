<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/general/head') %>
    <title>Manage Blog Posts - PromontolioBlog</title>
    <style>
      .admin-content {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }

      .page-header {
        background: linear-gradient(135deg, #3498db, #5dade2);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #3498db;
        box-shadow: 0 4px 20px rgba(52, 152, 219, 0.15);
      }

      .page-title {
        margin: 0;
        font-size: 2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      /* Fix dropdown functionality */
      .dropdown {
        position: relative;
      }

      .dropdown-toggle {
        background: rgba(255, 255, 255, 0.1) !important;
        border: 2px solid rgba(255, 255, 255, 0.2) !important;
        color: white !important;
        padding: 0.75rem;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .dropdown-toggle:hover {
        background: rgba(255, 255, 255, 0.2) !important;
        transform: rotate(90deg);
      }

      .dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border-radius: 8px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        min-width: 200px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        z-index: 1000;
        margin-top: 0.5rem;
      }

      .dropdown.active .dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        color: #333;
        text-decoration: none;
        transition: all 0.3s ease;
        font-size: 0.9rem;
      }

      .dropdown-item:hover {
        background-color: #f8f9fa;
        color: #3498db;
      }

      .dropdown-item.logout {
        color: #dc3545;
      }

      .dropdown-item.logout:hover {
        background-color: #dc3545;
        color: white;
      }

      .dropdown-divider {
        margin: 0.5rem 0;
        border: none;
        border-top: 1px solid #eee;
      }

      .filter-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        border-bottom: 2px solid #e9ecef;
      }

      .filter-tab {
        padding: 0.75rem 1.5rem;
        background: none;
        border: none;
        font-size: 1rem;
        font-weight: 600;
        color: #666;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
      }

      .filter-tab.active {
        color: #3498db;
        border-bottom-color: #3498db;
      }

      .filter-tab:hover {
        color: #3498db;
      }

      .articles-table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .table {
        width: 100%;
        border-collapse: collapse;
      }

      .table th {
        background: #f8f9fa;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #e9ecef;
      }

      .table td {
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
        vertical-align: top;
      }

      .table tr:hover {
        background: #f8f9fa;
      }

      .article-title-cell {
        max-width: 300px;
      }

      .article-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.25rem;
      }

      .article-excerpt {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-published {
        background: #d4edda;
        color: #155724;
      }

      .status-draft {
        background: #fff3cd;
        color: #856404;
      }

      .category-tag {
        background: #e9ecef;
        color: #495057;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .article-image {
        width: 60px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #e9ecef;
      }

      .no-image {
        width: 60px;
        height: 40px;
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-size: 0.8rem;
      }

      .article-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .btn {
        padding: 0.5rem 1rem;
        border-radius: 5px;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
      }

      .btn-primary {
        background: #8b5a3c;
        color: white;
      }

      .btn-primary:hover {
        background: #6d4530;
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.8rem;
      }

      .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        border-left: 4px solid #3498db;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #3498db;
        margin-bottom: 0.5rem;
      }

      .stat-label {
        color: #666;
        font-size: 0.9rem;
        margin: 0;
      }

      .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #666;
      }

      .empty-state i {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 1rem;
      }

      .empty-state a {
        margin-top: 2rem;
      }

      .search-filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        align-items: center;
      }

      .search-input {
        flex: 1;
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 5px;
        font-size: 1rem;
      }

      .search-input:focus {
        outline: none;
        border-color: #8b5a3c;
      }

      @media (max-width: 768px) {
        .admin-content {
          padding: 1rem;
        }

        .page-header {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }

        .articles-table {
          overflow-x: auto;
        }

        .table {
          min-width: 800px;
        }

        .search-filters {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <%- include('../partials/general/dashboardNavbar') %>

    <div class="admin-content">
      <!-- Page Header -->
      <div class="page-header">
        <h1 class="page-title">
          <i class="fas fa-newspaper"></i>
          Manage Blog Posts
        </h1>
        <a href="/admin/blog/new" class="btn btn-success">
          <i class="fas fa-plus"></i>
          Create New Post
        </a>
      </div>

      <!-- Statistics -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-number">
            <%= articles.filter(a => a.status === 'published').length %>
          </div>
          <p class="stat-label">Published Posts</p>
        </div>
        <div class="stat-card">
          <div class="stat-number">
            <%= articles.filter(a => a.status === 'draft').length %>
          </div>
          <p class="stat-label">Draft Posts</p>
        </div>
        <div class="stat-card">
          <div class="stat-number">
            <%= articles.reduce((sum, a) => sum + (a.viewCount || 0), 0) %>
          </div>
          <p class="stat-label">Total Views</p>
        </div>
        <div class="stat-card">
          <div class="stat-number"><%= articles.length %></div>
          <p class="stat-label">Total Posts</p>
        </div>
      </div>

      <!-- Search and Filters -->
      <div class="search-filters">
        <input
          type="text"
          id="searchInput"
          class="search-input"
          placeholder="Search articles by title..."
        />
        <select
          id="categoryFilter"
          class="search-input"
          style="flex: 0 0 200px"
        >
          <option value="">All Categories</option>
          <option value="olive-oil-guide">Olive Oil Guide</option>
          <option value="recipes">Recipes</option>
          <option value="health-benefits">Health Benefits</option>
          <option value="production">Production</option>
          <option value="news">News & Updates</option>
        </select>
      </div>

      <!-- Filter Tabs -->
      <div class="filter-tabs">
        <button class="filter-tab active" data-status="all">All Posts</button>
        <button class="filter-tab" data-status="published">Published</button>
        <button class="filter-tab" data-status="draft">Drafts</button>
      </div>

      <!-- Articles Table -->
      <% if (articles && articles.length > 0) { %>
      <div class="articles-table">
        <table class="table">
          <thead>
            <tr>
              <th>Image</th>
              <th>Title & Excerpt</th>
              <th>Category</th>
              <th>Status</th>
              <th>Views</th>
              <th>Author</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="articlesTableBody">
            <% articles.forEach(article => { %>
            <tr
              data-status="<%= article.status %>"
              data-category="<%= article.category || '' %>"
              data-title="<%= article.title.toLowerCase() %>"
            >
              <td>
                <% if (article.featuredImage) { %>
                <img
                  src="<%= article.featuredImage %>"
                  alt="<%= article.title %>"
                  class="article-image"
                />
                <% } else { %>
                <div class="no-image">
                  <i class="fas fa-image"></i>
                </div>
                <% } %>
              </td>
              <td class="article-title-cell">
                <div class="article-title"><%= article.title %></div>
                <% if (article.excerpt) { %>
                <div class="article-excerpt">
                  <%= article.excerpt.substring(0, 100) %><%=
                  article.excerpt.length > 100 ? '...' : '' %>
                </div>
                <% } %>
              </td>
              <td>
                <% if (article.category) { %>
                <span class="category-tag">
                  <%= article.category.replace(/-/g, ' ').replace(/\b\w/g, l =>
                  l.toUpperCase()) %>
                </span>
                <% } else { %>
                <span class="category-tag">Uncategorized</span>
                <% } %>
              </td>
              <td>
                <span class="status-badge status-<%= article.status %>">
                  <%= article.status %>
                </span>
              </td>
              <td>
                <i class="fas fa-eye"></i>
                <%= article.viewCount || 0 %>
              </td>
              <td><%= article.author?.username || 'Unknown' %></td>
              <td><%= new Date(article.createdAt).toLocaleDateString() %></td>
              <td>
                <div class="article-actions">
                  <a
                    href="/blog/<%= article.slug %>"
                    target="_blank"
                    class="btn btn-secondary btn-sm"
                    title="View Post"
                  >
                    <i class="fas fa-eye"></i>
                  </a>
                  <a
                    href="/admin/blog/<%= article._id %>/edit"
                    class="btn btn-primary btn-sm"
                    title="Edit"
                  >
                    <i class="fas fa-edit"></i>
                  </a>
                  <button
                    type="button"
                    class="btn btn-danger btn-sm delete-btn"
                    title="Delete"
                    data-article-id="<%= article._id %>"
                    data-article-title="<%= article.title %>"
                    data-article-status="<%= article.status %>"
                    data-article-date="<%= new Date(article.createdAt).toLocaleDateString() %>"
                    data-article-views="<%= article.viewCount || 0 %>"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
      <% } else { %>
      <div class="empty-state">
        <i class="fas fa-newspaper"></i>
        <h3>No blog posts yet</h3>
        <p>Start creating engaging content for your olive oil blog!</p>
        <a href="/admin/blog/new" class="btn btn-primary">
          <i class="fas fa-plus"></i>
          Create Your First Post
        </a>
      </div>
      <% } %>
    </div>

    <script>
      // Filter functionality
      const filterTabs = document.querySelectorAll(".filter-tab");
      const searchInput = document.getElementById("searchInput");
      const categoryFilter = document.getElementById("categoryFilter");
      const tableBody = document.getElementById("articlesTableBody");

      let currentStatusFilter = "all";
      let currentSearchTerm = "";
      let currentCategoryFilter = "";

      // Tab filtering
      filterTabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          // Update active tab
          filterTabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");

          currentStatusFilter = tab.dataset.status;
          applyFilters();
        });
      });

      // Search filtering
      searchInput.addEventListener("input", (e) => {
        currentSearchTerm = e.target.value.toLowerCase();
        applyFilters();
      });

      // Category filtering
      categoryFilter.addEventListener("change", (e) => {
        currentCategoryFilter = e.target.value;
        applyFilters();
      });

      function applyFilters() {
        const rows = tableBody.querySelectorAll("tr");

        rows.forEach((row) => {
          const status = row.dataset.status;
          const title = row.dataset.title;
          const category = row.dataset.category;

          let showRow = true;

          // Status filter
          if (currentStatusFilter !== "all" && status !== currentStatusFilter) {
            showRow = false;
          }

          // Search filter
          if (currentSearchTerm && !title.includes(currentSearchTerm)) {
            showRow = false;
          }

          // Category filter
          if (currentCategoryFilter && category !== currentCategoryFilter) {
            showRow = false;
          }

          row.style.display = showRow ? "" : "none";
        });
      }

      // Dropdown functionality
      const userDropdown = document.getElementById("userDropdown");
      console.log("User dropdown element:", userDropdown);

      if (userDropdown) {
        console.log("Dropdown found, adding event listener");
        userDropdown.addEventListener("click", function (e) {
          console.log("Dropdown clicked!");
          e.preventDefault();
          const dropdown = this.parentElement;
          console.log("Dropdown parent:", dropdown);
          dropdown.classList.toggle("active");
          console.log("Active class toggled, classes:", dropdown.className);
        });

        // Close dropdown when clicking outside
        document.addEventListener("click", function (e) {
          const dropdown = userDropdown.parentElement;
          if (!dropdown.contains(e.target)) {
            dropdown.classList.remove("active");
          }
        });
      } else {
        console.log("Dropdown element not found!");
      }
    </script>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal-overlay">
      <div class="modal-container">
        <div class="modal-header">
          <h3>
            <i class="fas fa-exclamation-triangle"></i> Confirm Article Deletion
          </h3>
          <button type="button" class="modal-close" id="modalCloseBtn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="warning-message">
            <p><strong>⚠️ Warning:</strong> This action cannot be undone!</p>
            <p>You are about to permanently delete the following article:</p>
          </div>
          <div class="article-details">
            <div class="detail-row">
              <strong>Title:</strong>
              <span id="modalArticleTitle"></span>
            </div>
            <div class="detail-row">
              <strong>Status:</strong>
              <span id="modalArticleStatus" class="status-badge"></span>
            </div>
            <div class="detail-row">
              <strong>Created:</strong>
              <span id="modalArticleDate"></span>
            </div>
            <div class="detail-row">
              <strong>Views:</strong>
              <span id="modalArticleViews"></span>
            </div>
          </div>
          <div class="consequences">
            <p><strong>This will:</strong></p>
            <ul>
              <li>✗ Permanently remove the article and all its content</li>
              <li>✗ Remove all comments and interactions</li>
              <li>✗ Break any external links to this article</li>
              <li>✗ Remove the article from search engines over time</li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="modalCancelBtn">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="button" class="btn btn-danger" id="modalConfirmBtn">
            <i class="fas fa-trash"></i> Yes, Delete Article
          </button>
        </div>
      </div>
    </div>

    <!-- Hidden form for deletion -->
    <form id="deleteForm" method="POST" style="display: none"></form>

    <style>
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(3px);
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal-container {
        background: white;
        border-radius: 12px;
        max-width: 550px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        transform: scale(0.9);
        opacity: 0;
        transition: all 0.3s ease;
      }

      .modal-overlay.active .modal-container {
        transform: scale(1);
        opacity: 1;
      }

      .modal-header {
        padding: 1.5rem;
        border-bottom: 2px solid #fee;
        background: #fdf2f2;
        border-radius: 12px 12px 0 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .modal-header h3 {
        margin: 0;
        color: #dc3545;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .modal-header h3 i {
        color: #ffc107;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #6c757d;
        cursor: pointer;
        padding: 0.25rem;
        transition: color 0.3s;
      }

      .modal-close:hover {
        color: #dc3545;
      }

      .modal-body {
        padding: 1.5rem;
      }

      .warning-message {
        background: #fff3cd;
        border: 1px solid #ffecb3;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid #ffc107;
      }

      .warning-message p {
        margin: 0.5rem 0;
        color: #856404;
      }

      .article-details {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
      }

      .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e9ecef;
      }

      .detail-row:last-child {
        border-bottom: none;
      }

      .consequences {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        padding: 1rem;
        border-left: 4px solid #dc3545;
      }

      .consequences p {
        margin: 0 0 0.5rem 0;
        color: #721c24;
        font-weight: 600;
      }

      .consequences ul {
        margin: 0.5rem 0 0 0;
        padding-left: 1.5rem;
        color: #721c24;
      }

      .consequences li {
        margin-bottom: 0.25rem;
      }

      .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e9ecef;
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        background: #f8f9fa;
        border-radius: 0 0 12px 12px;
      }

      .modal-footer .btn {
        min-width: 120px;
        justify-content: center;
      }

      @media (max-width: 600px) {
        .modal-container {
          width: 95%;
          margin: 1rem;
        }

        .modal-footer {
          flex-direction: column;
        }

        .modal-footer .btn {
          width: 100%;
        }
      }
    </style>

    <script>
      let currentArticleId = null;

      // Delete button click handlers
      document.querySelectorAll(".delete-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const articleId = this.dataset.articleId;
          const articleTitle = this.dataset.articleTitle;
          const articleStatus = this.dataset.articleStatus;
          const articleDate = this.dataset.articleDate;
          const articleViews = this.dataset.articleViews;

          showDeleteModal(
            articleId,
            articleTitle,
            articleStatus,
            articleDate,
            articleViews
          );
        });
      });

      // Modal event listeners
      document
        .getElementById("modalCloseBtn")
        .addEventListener("click", hideDeleteModal);
      document
        .getElementById("modalCancelBtn")
        .addEventListener("click", hideDeleteModal);
      document
        .getElementById("modalConfirmBtn")
        .addEventListener("click", confirmDelete);

      function showDeleteModal(articleId, title, status, date, views) {
        currentArticleId = articleId;

        // Populate modal with article details
        document.getElementById("modalArticleTitle").textContent = title;

        const statusElement = document.getElementById("modalArticleStatus");
        statusElement.textContent = status;
        statusElement.className = `status-badge status-${status}`;

        document.getElementById("modalArticleDate").textContent = date;
        document.getElementById(
          "modalArticleViews"
        ).innerHTML = `<i class="fas fa-eye"></i> ${views}`;

        // Show modal
        document.getElementById("deleteModal").classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function hideDeleteModal() {
        document.getElementById("deleteModal").classList.remove("active");
        document.body.style.overflow = "auto";
        currentArticleId = null;
      }

      function confirmDelete() {
        if (currentArticleId) {
          // Create and submit the delete form
          const form = document.getElementById("deleteForm");
          form.action = `/admin/blog/${currentArticleId}/delete`;
          form.submit();
        }
      }

      // Close modal when clicking overlay
      document
        .getElementById("deleteModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            hideDeleteModal();
          }
        });

      // Close modal with Escape key
      document.addEventListener("keydown", function (e) {
        if (
          e.key === "Escape" &&
          document.getElementById("deleteModal").classList.contains("active")
        ) {
          hideDeleteModal();
        }
      });
    </script>
  </body>
</html>
