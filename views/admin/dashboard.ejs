<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/general/head') %>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>PromontolioBlog - Dashboard</title>
  </head>
  <body>
    <%- include('../partials/general/dashboardNavbar') %>

    <div class="dashboard-container">
      <!-- Welcome Header -->
      <div class="welcome-header">
        <h1>Promontolio-Blog Dashboard</h1>
        <p>Welcome back! Here's your olive oil blog overview.</p>
      </div>

      <!-- Key Statistics -->
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <span class="stat-number"
            ><%= (stats && stats.totalPosts) || 0 %></span
          >
          <span class="stat-label">Total Blog Posts</span>
        </div>

        <div class="dashboard-card">
          <span class="stat-number"
            ><%= (stats && stats.totalSubscribers) || 0 %></span
          >
          <span class="stat-label">Newsletter Subscribers</span>
        </div>

        <div class="dashboard-card">
          <span class="stat-number"
            ><%= (stats && stats.postsThisMonth) || 0 %></span
          >
          <span class="stat-label">Posts This Month</span>
        </div>

        <div class="dashboard-card">
          <span class="stat-number"
            ><%= (stats && stats.recentSubscribers) || 0 %></span
          >
          <span class="stat-label">New Subscribers (30 days)</span>
        </div>
      </div>

      <!-- Analytics Charts Section -->
      <section class="dashboard-section analytics-section">
        <h2 class="section-title">üìä Blog Analytics</h2>

        <div class="charts-grid">
          <!-- Posts Timeline Chart -->
          <div class="chart-container">
            <h3 class="chart-title">Posts Published (Last 6 Months)</h3>
            <canvas id="postsChart" width="400" height="200"></canvas>
          </div>

          <!-- Subscribers Growth Chart -->
          <div class="chart-container">
            <h3 class="chart-title">Subscriber Growth (Last 6 Months)</h3>
            <canvas id="subscribersChart" width="400" height="200"></canvas>
          </div>

          <!-- Content Categories Chart -->
          <div class="chart-container">
            <h3 class="chart-title">Popular Content Tags</h3>
            <canvas id="categoriesChart" width="400" height="200"></canvas>
          </div>

          <!-- Top Content Performance -->
          <div class="chart-container performance-insights">
            <h3 class="chart-title">üèÜ Top Performing Content</h3>
            <div class="performance-list">
              <% if (analytics && analytics.topPosts &&
              analytics.topPosts.length > 0) { %> <% analytics.topPosts.slice(0,
              5).forEach((post, index) => { %>
              <div class="performance-item">
                <div class="rank-badge">#<%= index + 1 %></div>
                <div class="post-info">
                  <h4 title="<%= post.title %>"><%= post.title %></h4>
                  <span class="post-date">
                    <i class="fas fa-calendar"></i>
                    <%= new Date(post.createdAt).toLocaleDateString() %>
                  </span>
                  <% if (post.viewCount) { %>
                  <span class="post-views">
                    <i class="fas fa-eye"></i>
                    <%= post.viewCount %> views
                  </span>
                  <% } %>
                </div>
              </div>
              <% }) %> <% } else { %>
              <div class="no-data">
                <i class="fas fa-chart-line"></i>
                <p>No content data yet.</p>
                <a href="/admin/blog/new" class="btn-small"
                  >Create your first post</a
                >
              </div>
              <% } %>

              <div class="insights-summary">
                <h4>üìä Content Insights</h4>
                <ul class="insights-list">
                  <li>
                    <strong>Publishing frequency:</strong>
                    <%= ((stats && stats.postsThisMonth) || 0) %> posts this
                    month
                  </li>
                  <li>
                    <strong>Growth rate:</strong>
                    <%= ((stats && stats.recentSubscribers) || 0) %> new
                    subscribers (30 days)
                  </li>
                  <li>
                    <strong>Content library:</strong>
                    <%= ((stats && stats.totalPosts) || 0) %> total articles
                    published
                  </li>
                  <% if (analytics && analytics.postsByCategory &&
                  analytics.postsByCategory.length > 0) { %>
                  <li>
                    <strong>Most popular topic:</strong>
                    <%= analytics.postsByCategory[0]._id || 'General' %> (<%=
                    analytics.postsByCategory[0].count %> posts)
                  </li>
                  <% } %>
                </ul>

                <div class="action-recommendations">
                  <h5>üí° Recommendations:</h5>
                  <% if ((stats && stats.postsThisMonth) || 0 < 2) { %>
                  <div class="recommendation text-warning">
                    <i class="fas fa-arrow-up"></i>
                    <span
                      >Consider posting more frequently - aim for 2-3 posts per
                      month</span
                    >
                  </div>
                  <% } %> <% if ((stats && stats.totalSubscribers) || 0 < 10) {
                  %>
                  <div class="recommendation text-info">
                    <i class="fas fa-users"></i>
                    <span
                      >Promote your newsletter signup to grow your subscriber
                      base</span
                    >
                  </div>
                  <% } %> <% if ((stats && stats.totalPosts) || 0 > 5) { %>
                  <div class="recommendation text-success">
                    <i class="fas fa-search"></i>
                    <span
                      >Add search functionality to help readers find your
                      content</span
                    >
                  </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Quick Actions -->
      <section class="dashboard-section">
        <h2 class="section-title">‚ö° Quick Actions</h2>
        <div class="quick-actions">
          <a href="/admin/blog/new" class="action-btn create"
            >‚úçÔ∏è Write New Post</a
          >
          <a href="/admin/blog" class="action-btn">üìù Manage Posts</a>
          <a href="/admin/users" class="action-btn">üë• Manage Users</a>
          <a href="/blog" class="action-btn view-site" target="_blank"
            >üåê View Public Blog</a
          >
          <a href="/auth/logout" class="action-btn logout">üö™ Logout</a>
        </div>
      </section>

      <!-- Recent Activity Section -->
      <section class="dashboard-section">
        <h2 class="section-title">üìà Recent Activity</h2>
        <div class="dashboard-grid">
          <div class="recent-section">
            <div class="recent-items">
              <h3>üìù Recent Blog Posts</h3>
              <% if (stats && stats.recentPosts && stats.recentPosts.length > 0)
              { %> <% stats.recentPosts.forEach(post => { %>
              <div class="recent-item">
                <strong><%= post.title %></strong><br />
                <small
                  >Published: <%= new Date(post.createdAt).toLocaleDateString()
                  %></small
                >
              </div>
              <% }) %> <% } else { %>
              <div class="recent-item">
                <em
                  >No posts yet.
                  <a href="/admin/blog/new">Create your first post!</a></em
                >
              </div>
              <% } %>
            </div>
          </div>

          <div class="recent-section">
            <div class="recent-items">
              <h3>üìß Recent Subscribers</h3>
              <% if (stats && stats.recentSubscribersList &&
              stats.recentSubscribersList.length > 0) { %> <%
              stats.recentSubscribersList.forEach(subscriber => { %>
              <div class="recent-item">
                <strong><%= subscriber.email %></strong><br />
                <small
                  >Subscribed: <%= new
                  Date(subscriber.createdAt).toLocaleDateString() %></small
                >
              </div>
              <% }) %> <% } else { %>
              <div class="recent-item">
                <em
                  >No subscribers yet. Share your blog to grow your
                  audience!</em
                >
              </div>
              <% } %>
            </div>
          </div>
        </div>
      </section>

      <!-- Business Tips Section -->
      <section class="dashboard-section business-tip">
        <h2 class="section-title">
          üå± Content Strategy for Your Olive Oil Business
        </h2>
        <div class="tip-grid">
          <div class="tip-card">
            <h4>üìù Content Ideas</h4>
            <p>
              Write about olive harvesting seasons, health benefits of extra
              virgin olive oil, traditional vs modern pressing methods.
            </p>
          </div>
          <div class="tip-card">
            <h4>üë• Audience Engagement</h4>
            <p>
              Share behind-the-scenes content from your olive groves, recipe
              tutorials, and customer testimonials.
            </p>
          </div>
          <div class="tip-card">
            <h4>üìä SEO Tips</h4>
            <p>
              Use keywords like "extra virgin olive oil", "organic olives",
              "Mediterranean recipes" to improve search rankings.
            </p>
          </div>
        </div>
      </section>
    </div>

    <!-- Simple Admin Footer -->
    <footer class="admin-footer">
      <div class="admin-footer-content">
        <p>
          &copy; 2025 PromontolioBlog Admin Panel |
          <a href="/blog" target="_blank">View Public Site</a>
        </p>
      </div>
    </footer>

    <!-- Analytics Data in data attribute -->
    <div
      id="analytics-data"
      style="display: none"
      data-analytics="<%- JSON.stringify(analytics || {}) %>"
    ></div>

    <!-- Chart.js Analytics Implementation -->
    <script>
      // Wait for DOM and Chart.js to be ready
      document.addEventListener("DOMContentLoaded", function () {
        // Check if Chart.js is loaded
        if (typeof Chart === "undefined") {
          console.error("Chart.js failed to load");
          return;
        }

        // Check if analytics data exists and parse safely
        var analyticsData;
        try {
          // Get analytics data from data attribute
          var dataElement = document.getElementById("analytics-data");
          var dataJson = dataElement
            ? dataElement.getAttribute("data-analytics")
            : null;

          // Validate JSON string exists and is not empty
          if (!dataJson || dataJson.trim() === "" || dataJson === "undefined") {
            console.warn("No analytics data found, using empty object");
            analyticsData = {};
          } else {
            analyticsData = JSON.parse(dataJson);
          }
        } catch (e) {
          console.error("Failed to parse analytics data:", e);
          console.log("Raw data:", dataJson);
          analyticsData = {
            postsPerMonth: [],
            subscribersPerMonth: [],
            postsByCategory: [],
            topPosts: [],
          };
        }

        // Chart configuration
        Chart.defaults.font.family = "Roboto, Arial, sans-serif";
        Chart.defaults.font.size = 12;
        Chart.defaults.color = "#666";

        // Shared variables
        const monthNames = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];

        // 1. Posts Timeline Chart
        try {
          if (document.getElementById("postsChart")) {
            const postsCtx = document
              .getElementById("postsChart")
              .getContext("2d");

            // Prepare posts data
            const postsData = analyticsData.postsPerMonth || [];
            const postsLabels = [];
            const postsCounts = [];

            // Generate last 6 months labels
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
              const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
              const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
              const monthLabel = `${
                monthNames[date.getMonth()]
              } ${date.getFullYear()}`;
              postsLabels.push(monthLabel);

              // Find matching data
              const found = postsData.find(
                (item) =>
                  item._id.year === date.getFullYear() &&
                  item._id.month === date.getMonth() + 1
              );
              postsCounts.push(found ? found.count : 0);
            }

            new Chart(postsCtx, {
              type: "line",
              data: {
                labels: postsLabels,
                datasets: [
                  {
                    label: "Posts Published",
                    data: postsCounts,
                    borderColor: "#2E7D32",
                    backgroundColor: "rgba(46, 125, 50, 0.1)",
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false,
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      stepSize: 1,
                    },
                  },
                },
              },
            });
          }
        } catch (error) {
          console.error("Error creating posts chart:", error);
        }

        // 2. Subscribers Growth Chart
        try {
          if (document.getElementById("subscribersChart")) {
            var subsCtx = document
              .getElementById("subscribersChart")
              .getContext("2d");
            var subsData = analyticsData.subscribersPerMonth || [];
            var subsLabels = [];
            var subsCounts = [];

            // Generate last 6 months labels for subscribers
            var now = new Date();
            for (var i = 5; i >= 0; i--) {
              var date = new Date(now.getFullYear(), now.getMonth() - i, 1);
              var monthLabel =
                monthNames[date.getMonth()] + " " + date.getFullYear();
              subsLabels.push(monthLabel);

              var found = subsData.find(function (item) {
                return (
                  item._id.year === date.getFullYear() &&
                  item._id.month === date.getMonth() + 1
                );
              });
              subsCounts.push(found ? found.count : 0);
            }

            new Chart(subsCtx, {
              type: "bar",
              data: {
                labels: subsLabels,
                datasets: [
                  {
                    label: "New Subscribers",
                    data: subsCounts,
                    backgroundColor: "#FFA726",
                    borderColor: "#FF9800",
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false,
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      stepSize: 1,
                    },
                  },
                },
              },
            });
          }
        } catch (error) {
          console.error("Error creating subscribers chart:", error);
        }

        // 3. Content Categories Chart
        try {
          if (document.getElementById("categoriesChart")) {
            var catsCtx = document
              .getElementById("categoriesChart")
              .getContext("2d");

            var catsData = analyticsData.postsByCategory || [];
            var catsLabels = catsData.map(function (item) {
              return item._id || "Uncategorized";
            });
            var catsCounts = catsData.map(function (item) {
              return item.count;
            });

            var colors = [
              "#4CAF50",
              "#2196F3",
              "#FF9800",
              "#9C27B0",
              "#F44336",
              "#00BCD4",
              "#8BC34A",
              "#E91E63",
            ];

            new Chart(catsCtx, {
              type: "doughnut",
              data: {
                labels: catsLabels,
                datasets: [
                  {
                    data: catsCounts,
                    backgroundColor: colors.slice(0, catsLabels.length),
                    borderWidth: 2,
                    borderColor: "#fff",
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: "bottom",
                    labels: {
                      padding: 15,
                      usePointStyle: true,
                    },
                  },
                },
              },
            });
          }
        } catch (error) {
          console.error("Error creating categories chart:", error);
        }
      }); // End DOMContentLoaded
    </script>
  </body>
</html>
